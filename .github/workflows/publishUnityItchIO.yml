name: Publish Unity game to Itch.io ğŸ®

on:
  push:
    branches: [master]
    paths:
        - 'BotRoyaleUnity/**'
        - '!BotRoyaleUnity/readme.md'
        - '.github/workflows/publishUnityItchIO.yml'

env:
  UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}

jobs:
  buildAndPublish:
    name: ğŸ“¦ Make WebGL build of Unity game and publish it to Itch.io
    runs-on: ubuntu-latest
    steps:
      # Checkout
      - name: ğŸ‘€ Checkout repository
        uses: actions/checkout@v2
        with:
          lfs: true
    
      # Cache
      - name: ğŸ’¸ Cache Library folder
        uses: actions/cache@v1.1.0
        with:
          path: BotRoyaleUnity/Library
          key: Library

      # Build
      - name: ğŸ— Build Unity project
        uses: webbertakken/unity-builder@v0.10
        with:
          projectPath: BotRoyaleUnity
          unityVersion: 2019.3.1f1
          targetPlatform: WebGL

      # Output
      - name: ğŸ’¾ Save build artifact
        uses: actions/upload-artifact@v1
        with:
          name: WebGLBuild
          path: build

      # Upload
      - name: ğŸ‰ Upload to Itch.io
        uses: josephbmanley/butler-publish-itchio-action@master
        env:
          BUTLER_CREDENTIALS: ${{ secrets.BUTLER_API_KEY }}
          CHANNEL: html5
          ITCH_GAME: build-a-bot-royale
          ITCH_USER: buildabot
          PACKAGE: build/WebGL
